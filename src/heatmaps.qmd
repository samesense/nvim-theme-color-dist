---
title: "CIELAB Distance Heatmaps"
format: html
execute:
  echo: true
---

```{r}
# Setup: install packages if missing
if (!requireNamespace("ComplexHeatmap", quietly=TRUE)) {
  if (!requireNamespace("BiocManager", quietly=TRUE)) install.packages("BiocManager")
  BiocManager::install("ComplexHeatmap")
}
pkgs <- c("circlize", "tidyverse")
for (p in pkgs) if (!requireNamespace(p, quietly=TRUE)) install.packages(p)

library(tidyverse)
library(ComplexHeatmap)
library(circlize)
```

```{r echo=FALSE, results='asis'}
pal_dir <- "data/raw/nvim/lua/catppuccin/palettes"
csvs <- list.files(pal_dir, pattern = "\\.csv$", full.names = TRUE)
if (length(csvs) == 0) stop("No CSV palette distance files found in ", pal_dir)

for (f in csvs) {
  df <- readr::read_csv(f, show_col_types = FALSE)
  name <- tools::file_path_sans_ext(basename(f))
  cat(sprintf("## Palette: %s\n\n", name))

  elems <- unique(c(df$element1, df$element2))
  mat <- matrix(0, nrow = length(elems), ncol = length(elems), dimnames = list(elems, elems))

  for (i in seq_len(nrow(df))) {
    a <- df$element1[i]; b <- df$element2[i]; d <- df$distance[i]
    mat[a, b] <- d; mat[b, a] <- d
  }
  diag(mat) <- 0

  maxd <- max(mat, na.rm = TRUE)
  col_fun <- colorRamp2(c(0, maxd * 0.5, maxd), c("white", "orange", "red"))

  ht <- Heatmap(mat,
                name = "CIELAB \u0394E",
                col = col_fun,
                show_row_names = TRUE,
                show_column_names = TRUE,
                cluster_rows = TRUE,
                cluster_columns = TRUE,
                column_title = name)

  draw(ht, heatmap_legend_side = "right")
}
```
